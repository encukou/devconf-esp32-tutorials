% arara: lualatex
% arara: lualatex
% Typeset using lualatex

\documentclass{../tutorial}

\title{System setup for MicroPython \abbr{ESP32} hacking}

\begin{document}

These instructions are for Fedora.
Other systems might be different â€“ try your luck!

\begin{enumerate}

\section{Installation}

\item
    Open up a terminal and type:

    \begin{lstlisting}[language=bash]
    dnf install picocom ampy
    \end{lstlisting}

    If you're not on Fedora and don't have these packages,
    `screen` would do instead of `picocom`,
    and `ampy` can be installed via
    `python3 -m pip install --user adafruit-ampy`.

\item
    Get yourself to the `dialout` group.
    You can use:

    \begin{lstlisting}[language=bash]
    usermod -a -G $(whoami)
    \end{lstlisting}

    but make sure to login again after that
    (e.g. \lstinline|su - $(whoami)|).
    Verify that you are in the group by running the `groups` command.

    \begin{comment}
        The `dialout` group is historically designed for modems
        and gives you full and direct access to serial ports.
    \end{comment}

\item
    You need drivers for the on-board \abbr{CP2102} \abbr{USB}-serial adapter.
    If you are using Linux, you have them.
    If you are not using Linux, may the force be with you
    (ask booth attendants for help).

\section{Talking to the board}

    \begin{comment}
        To protect delicate pins and make connections easier,
        the black \abbr{ESP32} devkit is plugged into a white OctopusLab Robot~Board.
        Please ask if you want to unplug it.
    \end{comment}

\item
    Connect the \abbr{ESP32} board via an \abbr{USB} cable.
    Sometimes, the cable or even the board can be faulty,
    use `dmesg | tail` to verify your system can actually see the board.
    Ask for help if it doesn't.

\item
    Use \texttt{picocom} to get the interactive interpreter.
    The full command is:

    \begin{lstlisting}[language=bash]
    picocom -b 115200 --flow n /dev/ttyUSB0
    \end{lstlisting}

    The first number specifies the baud rate -- a speed of communication over serial line.
    All our \abbr{ESP32} boards communicate using this baud rate.
    We disable the flow control of the serial-port.
    That should be the default,
    but explicit is better than implicit.

    Lastly, we connect to `/dev/ttyUSB0`.
    That's the file representing our device (or the serial line to it).
    The filename may be different, consult the `dmesg | tail` output.

    If you need to use `screen`,
    the command is `screen /dev/ttyUSB0 115200`.

\item
    You should see `Terminal ready`.
    Pres Enter and the MicroPython's interactive prompt with `>>>` should appear.
    If you see wall of random characters instead,
    locate and press the `EN` button on the device
    (it's near the USB port).

\item
    Experiment with the interactive Python prompt. Is it Python?
    Can you `print` stuff? Is something missing?

    If you prefer to code in your favorite text editor,
    you can use \kbd{Ctrl}+\kbd{e} to activate the \emph{paste mode}.

\item
    To exit `picocom`, hold the \kbd{Ctrl} key, press \kbd{a},
    then \kbd{q} and lift the \kbd{Ctrl} key.
    Alternatively, unplug the board.

\section{The board's filesystem}

\item
    The board has a simple filesystem.
    To execute a file on the board when the board starts,
    write a program on your computer and save it as `main.py`.
    Use `ampy` to put the file into the board:

    \begin{lstlisting}[language=bash]
    ampy -p /dev/ttyUSB0 put main.py
    \end{lstlisting}

    Connect via `picocom`, then press the \emph{EN} button to see
    what is happening. Use \kbd{Ctrl}+\kbd{c} to interrupt a running program.
    Use \lstinline[emph=rm]|ampy -p /dev/ttyUSB0 rm main.py|
    to get rid of the file.
    Explore `ampy --help` to see what else is possible.

\item
    Congratulations, you've made it! Now you are ready to pick a task.

    \begin{comment}
        Don't forget to ask for stickers as a reward for your efforts!
    \end{comment}

\end{enumerate}

\end{document}
